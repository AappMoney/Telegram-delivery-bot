const Telegraf = require('telegraf');
const env = require('dotenv');
const nodemailer = require('nodemailer');

const Extra = require('telegraf/extra')
const Markup = require('telegraf/markup')

const DB = require('./mongoDb/mongodb.js');
const User = require('./mongoDb/user.js');
const { type } = require('os');

const db = new DB();
db.connect();
env.config();

const TOKEN = process.env.BOT_TOKEN || '';
const bot = new Telegraf(TOKEN);

const menues = {
    'globalMenuUZ' : {
        'globl' : [`Buyurtma berish`,`Biz¬†haqmizda`, `Sozlamalar`],
        'delivery' : [[`Yetkazib berish`, `Olib ketish`],[`Orqaga`]],
        'locationMenu': [['Eng yaqin filialimizni aniqlash'],[`Orqaga`]]
    },
    'globalMenuRU': {
        'globl' : [`–ó–∞–∫–∞–∑–∞—Ç—å`,`–û –Ω–∞—Å`, `–ù–∞—Å—Ç—Ä–æ–π–∫–∏`],
        'delivery' : [[`–î–æ—Å—Ç–∞–≤–∫–∞`, `–°–∞–º–æ–≤—ã–≤–æ–∑`],[`–ù–∞–∑–∞–¥`]],
        'locationMenu': [['¬´–û–ø—Ä–µ–¥–µ–ª–∏—Ç–µ –Ω–∞—à –±–ª–∏–∂–∞–π—à–∏–π —Ñ–∏–ª–∏–∞–ª¬ª'],[`–ù–∞–∑–∞–¥`]]
    }
}

const regionsUz = [
    [`Toshkent`, `Andijon`],
    [`Qarshi`, `Farg'ona`],
    [`Samarqand`]
]
const regionsRu = [
    [`–¢–∞—à–∫–µ–Ω—Ç`, `–ê–Ω–¥–∏–∂–∞–Ω`],
    [`–ö–∞—Ä—à–∏`, `–§–µ—Ä–≥–∞–Ω–∞`],
    [`–°–∞–º–∞—Ä–∫–∞–Ω–¥`]
]

const userMenu = [
    [
        `Telefon raqamini o'zgartirish`,
        `Kodni yana bir bor yuboring`
    ],
    [
        '–ò–∑–º–µ–Ω–∏—Ç—å –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞',
        '–û—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–æ–¥ –µ—â–µ —Ä–∞–∑'
    ]
]

// BOT'S WORD
const LANGUAGE = [
    [
        'Ismi-sharifingizni kiriting:', // 0
        'Asosiy menyu',     // 1
        `üì± Telefon raqamingizni yozib yuboring :
        +998 ** *** ** **`,     // 2
        'Telefon raqamini yuboring',    // 3
        `Siz qaysi shaharda istiqomat qilasiz?`,    // 4
        `Sizning¬†telefon¬†raqamingizga¬†kod yuborildi¬†kodni¬†yozing¬†va¬†profilingizni¬†faollashtiring!`, // 5
        `Iltimos¬†email¬†manzilingizni¬†yozing!`,  // 6
        `Sizning¬†email¬†manzilingizga¬†kod yuborildi¬†kodni¬†yozing¬†va¬†profilingizni¬†faollashtiring!`,  // 7
        `Siz royhatdan ola darajada otingiz endi siz bemalol botga buyurtmalar berishingiz mumkin !`,   // 8

        `Buyurtmani o'zingiz olib ketasizmi yoki Yetkazib beramizmi`,   // 9
        `Location jonatsangiz sizga eng yaqin bolgan filialni aniqlaymiz va yetkazib berish xarajatlarini aniqlaymiz `, // 10
        `Qaerdasiz Agar Location yuborsangiz, sizga eng yaqin filialni aniqlaymiz`,  // 11

    ],
    [
        '–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è:',    // 0
        '–ì–ª–∞–≤–Ω—ã–π –º–µ–Ω—é ',    // 1
        `üì± –í–≤–µ–¥–∏—Ç–µ —Å–≤–æ–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞:
        +998 ** *** ** **`,    // 2
        `–û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞`,    // 3
        `–í –∫–∞–∫–æ–º –≥–æ—Ä–æ–¥–µ –≤—ã –∂–∏–≤–µ—Ç–µ?`,    // 4
        `–ù–∞–ø–∏—à–∏—Ç–µ –∫–æ–¥, –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –Ω–∞ –≤–∞—à –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞, –∏ –∞–∫—Ç–∏–≤–∏—Ä—É–π—Ç–µ —Å–≤–æ–π –ø—Ä–æ—Ñ–∏–ª—å!`,    // 5
        `–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å —ç–º–∞–∏–ª!`,    // 6
        `–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥, –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –Ω–∞ –≤–∞—à –∞–¥—Ä–µ—Å —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–æ–π –ø–æ—á—Ç—ã, –∏ –∞–∫—Ç–∏–≤–∏—Ä—É–π—Ç–µ —Å–≤–æ–π –ø—Ä–æ—Ñ–∏–ª—å!`,    // 7
        `–í—ã —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–∏–ª–∏, —Ç–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –∑–∞–∫–∞–∑–∞—Ç—å –±–ª—é–¥–æ, –∫–æ—Ç–æ—Ä–æ–µ –≤—ã —Ö–æ—Ç–∏—Ç–µ`,    // 8

        `–ó–∞–±–µ—Ä–∏—Ç–µ —Å–≤–æ–π –∑–∞–∫–∞–∑ —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –¥–æ—Å—Ç–∞–≤–∫—É`,    // 9
        `–ö—É–¥–∞ –Ω—É–∂–Ω–æ –¥–æ—Å—Ç–∞–≤–∏—Ç—å –≤–∞—à –∑–∞–∫–∞–∑ –ï—Å–ª–∏ –≤—ã –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ –ª–æ–∫–∞—Ü–∏—é, –º—ã –æ–ø—Ä–µ–¥–µ–ª–∏–º –±–ª–∏–∂–∞–π—à–∏–π –∫ –≤–∞–º —Ñ–∏–ª–∏–∞–ª –∏ —Å—Ç–æ–∏–º–æ—Å—Ç—å –¥–æ—Å—Ç–∞–≤–∫–∏ `,    // 10
        `–ì–¥–µ –≤—ã –Ω–∞—Ö–æ–¥–∏—Ç–µ—Å—å. –ï—Å–ª–∏ –≤—ã –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ –ª–æ–∫–∞—Ü–∏—é, –º—ã –æ–ø—Ä–µ–¥–µ–ª–∏–º –±–ª–∏–∂–∞–π—à–∏–π –∫ –≤–∞–º —Ñ–∏–ª–∏–∞–ª`,    // 11
    ],
]

// START BOT
bot.start(async (ctx) => {
    let controlCallback;

    const findUser = await User.findOne({idTg: ctx.message.from.id});
    // const user = users.findIndex(elem => elem.idTG === ctx.message.from.id);
    // console.log(user)

        if(!findUser) {
            ctx.reply(`Assalomu¬†Alaykum¬†Delivery¬†botiga¬†xush¬†kelibsiz¬†marhamat¬†tilni¬†tanlang !
–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –±–æ—Ç Delivery, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫ !`, 
            Markup.inlineKeyboard([
                Markup.callbackButton(`O'ZBEK üá∫üáø`, 'UZ'),
                Markup.callbackButton('–†–£–°–°–ö–ò–ô üá∑üá∫', 'RU'),
            ]).extra());
            
            bot.on('callback_query', async (ctx) => {
                const chatID = ctx.callbackQuery.message.chat.id;
                const msgID = ctx.callbackQuery.message.message_id;
                const userTgId = ctx.callbackQuery.from.id;
                
                if(!controlCallback){
                    if(ctx.callbackQuery.data) {
                        const lang = (ctx.callbackQuery.data === 'UZ') ? 'UZ' : 'RU';
                        controlCallback = true;
                        const newUser = {
                            name: '',
                            idTg: userTgId,
                            userLang: lang,
                            city: '',
                            phone: '',
                            gmail: ''
                        }
                    const newUserAdddb = await User.create(newUser);
                    bot.telegram.deleteMessage(chatID,msgID);
                    ctx.reply((lang === 'UZ') ? LANGUAGE[0][0] : LANGUAGE[1][0]);
                    }
                }

            });
        }

    if(findUser) {

        if(findUser.name === '') {
            ctx.reply((findUser.userLang === 'UZ') ? LANGUAGE[0][0] : LANGUAGE[1][0]);
        }else if(findUser.city === '') {
            // const menu = (findUser.userLang === 'UZ') ? userMenu[0] : userMenu[1];

            ctx.reply((findUser.userLang === 'UZ') ? LANGUAGE[0][4] : LANGUAGE[1][4],  Markup.keyboard((findUser.userLang === 'UZ') ? regionsUz : regionsRu).resize().extra());
        }else if(findUser.phone === '') {            
            var option = {
                "reply_markup": {
                    "one_time_keyboard": true,
                    "keyboard": [[{
                        text: (findUser.userLang === 'UZ') ? LANGUAGE[0][3] : LANGUAGE[1][3],
                        request_contact: true
                    }]],
                    "one_time_keyboard": true,
                    "resize_keyboard": true,
                }
            };
            ctx.reply((findUser.userLang === 'UZ') ? LANGUAGE[0][2] : LANGUAGE[1][2], option);
        }else {

            ctx.reply((findUser.userLang === 'UZ') ? LANGUAGE[0][1] : LANGUAGE[1][1], Markup.keyboard((findUser.userLang === 'UZ') ? menues['globalMenuUZ']['globl'] : menues['globalMenuRU']['globl']).resize().extra());
        }
    }
});

const randomNumberFn = (min, max) => {
    return Math.floor(Math.random() * (max - min) + min);
}

let ramdomNumPast;


const sendMailUser = (userGmailCtx) => {

    ramdomNumPast = randomNumberFn(1000, 9999);

    let mailOptions = {
        from: process.env.userGmail,
        to: userGmailCtx,
        subject: 'Delivery bot',
        text: `Profilingizni foallashtrishingiz ushun maxsus kode: ${ ramdomNumPast }`
    }

    let transporter = nodemailer.createTransport({
        service: 'gmail',
        auth: {
            user: process.env.userGmail, // generated ethereal user
            pass: process.env.pass, // generated ethereal password
        },
    });

    transporter.sendMail(mailOptions, (error, info) => {
        if(error) return console.log(error)
        console.log("NIce" + info.response)
    });
}



bot.on('text', async (ctx) => {
    if(ctx.message.text === 'delete') {
    const user = await User.deleteOne({idTg: ctx.message.from.id});
    return;
    }
    
    // bot.on('callback_query', async ctx => {
    //     if (ctx.data == `back3`) {
    //         ctx.reply('siz orqaga qaytingiz')
    //    }
    // })

    const user = await User.findOne({idTg: ctx.message.from.id});
    const menuesLocal = (user.userLang === 'UZ') ? menues['globalMenuUZ'] : menues['globalMenuRU'];


    var option = {
        "reply_markup": {
            "one_time_keyboard": true,
            "keyboard": [[{
                text: (user.userLang === 'UZ') ? LANGUAGE[0][3] : LANGUAGE[1][3],
                request_contact: true
            }]],
            "one_time_keyboard" : true,
        "resize_keyboard" : true,
        }
    };


    if(ctx.message.text === `Buyurtma berish` || ctx.message.text === `–ó–∞–∫–∞–∑`) {
        ctx.reply((user.userLang === "UZ") ? LANGUAGE[0][9] : LANGUAGE[1][9],  Markup.keyboard(menuesLocal['delivery']).resize().extra());
    }else if(ctx.message.text === `Yetkazib berish` || ctx.message.text === `–î–æ—Å—Ç–∞–≤–∫–∞`) {
        ctx.reply((user.userLang === "UZ") ? LANGUAGE[0][10] : LANGUAGE[1][10],  Markup.keyboard(menuesLocal['locationMenu']).resize().extra());
    }

    if(user.name === '') {
        const UPDATE_DATE = await User.updateOne({"idTg": ctx.message.from.id}, {$set : {"name" : ctx.message.text}});
        ctx.reply((user.userLang === 'UZ') ? LANGUAGE[0][4] : LANGUAGE[1][4],  Markup.keyboard((user.userLang === 'UZ') ? regionsUz : regionsRu).resize().extra());
    }else if(ctx.message.text === `Telefon raqamini o'zgartirish` || ctx.message.text === `–ò–∑–º–µ–Ω–∏—Ç—å –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞` && user.phone !== ''){
        const UPDATE_DATE = await User.updateOne({"idTg": ctx.message.from.id}, {$set : {"phone" : ''}});
        
        ctx.reply((user.userLang === 'UZ') ? LANGUAGE[0][2] : LANGUAGE[1][2], option);
    }else if(ctx.message.text === `Kodni yana bir bor yuboring` || ctx.message.text === `–û—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–æ–¥ –µ—â–µ —Ä–∞–∑` && user.gmail !== '') {
        sendMailUser(user.gmail);
        const menu = (user.userLang === 'UZ') ? userMenu[0] : userMenu[1];
        ctx.reply((user.userLang === "UZ") ? LANGUAGE[0][7] : LANGUAGE[1][7],  Markup.keyboard(menu).resize().extra());
    }else if(user.city === '') {
        const UPDATE_DATE = await User.updateOne({"idTg": ctx.message.from.id}, {$set : {"city" : ctx.message.text}});
        
        ctx.reply((user.userLang === 'UZ') ? LANGUAGE[0][2] : LANGUAGE[1][2], option);
    }else if(user.phone === '') {
        // const regexp = /^[\+]?[(]?[0-9]{3}[)]?[-\s\.]?[0-9]{3}[-\s\.]?[0-9]{4,6}$/im.test(ctx.message.text)
        const regexp = /^[\+]?[(]?[0-9]{3}[)]?[-\s\.]?[0-9]{3}[-\s\.]?[0-9]{3,6}$/im.test(ctx.message.text);

        console.log(typeof ctx.message.text, regexp)
        const menu = (user.userLang === 'UZ') ? userMenu[0] : userMenu[1];
        if(regexp) {
            const UPDATE_DATE = await User.updateOne({"idTg": ctx.message.from.id}, {$set : {"phone" : ctx.message.text}});
    
            const menu = (user.userLang === 'UZ') ? userMenu[0] : userMenu[1];
            // Markup.keyboard(menu).resize().extra()
            ctx.reply((user.userLang === "UZ") ? LANGUAGE[0][6] : LANGUAGE[1][6],  Markup.keyboard(menu).resize().extra());
        }else {
            ctx.reply((user.userLang === 'UZ') ? LANGUAGE[0][2] : LANGUAGE[1][2],  Markup.keyboard(menu).resize().extra());
        }
    }else if(user.gmail === '') {
        const UPDATE_DATE = await User.updateOne({"idTg": ctx.message.from.id}, {$set : {"gmail" : ctx.message.text}});

        const userGmailCtx = ctx.message.text;

        sendMailUser(userGmailCtx);

        const menu = (user.userLang === 'UZ') ? userMenu[0] : userMenu[1];
        
        ctx.reply((user.userLang === "UZ") ? LANGUAGE[0][7] : LANGUAGE[1][7],  Markup.keyboard(menu).resize().extra());

    }else if(parseInt(ctx.message.text) === ramdomNumPast && user.gmail !== '') {
        ramdomNumPast = '';
        ctx.reply((user.userLang === 'UZ') ? LANGUAGE[0][8] : LANGUAGE[1][8], Markup.keyboard(menuesLocal['globl']).resize().extra());

    }else {
        return
    }

});

bot.on('contact', async(ctx) => {
    const user = await User.findOne({idTg: ctx.message.from.id});

    if(user.phone === '') {
        const UPDATE_DATE = await User.updateOne({"idTg": ctx.message.from.id}, {$set : {"phone" : ctx.message.contact.phone_number}});

        const menu = (user.userLang === 'UZ') ? userMenu[0] : userMenu[1];
        ctx.reply((user.userLang === "UZ") ? LANGUAGE[0][6] : LANGUAGE[1][6], Markup.keyboard(menu).resize().extra());
    }
    // console.log(user);
});

bot.launch()
    .then(() => {
     console.log('bot start')   
    }).catch((err) => {
        console.log('lounch error: ' + err);
    });

bot.startPolling();